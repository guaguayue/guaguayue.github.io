<!DOCTYPE html>
<!--
    Type on Strap jekyll theme v2.3.6
    Copyright 2016-2021 Sylhare
    Theme free for personal and commercial use under the MIT license
    https://github.com/sylhare/Type-on-Strap/blob/master/LICENSE
-->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=0.5, maximum-scale=5">

    <!-- Theme Mode-->
    
    <script>
        const isAutoTheme = true;
        document.documentElement.setAttribute('data-theme', sessionStorage.getItem('theme'))
    </script>
    

    <!-- Main JS (navbar.js, katex_init.js and masonry_init.js)-->
    <script defer src="/assets/js/main.min.js"></script>
    
    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">

    <!--Favicon-->
    <link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon">

    <!-- RSS -->
    <link rel="alternate" type="application/atom+xml" title="Guo Yue Blog" href="https://sylhare.github.io/feed.xml"/>

    

    <!-- KaTeX 0.13.9 -->
    
    <script defer src="/assets/js/vendor/katex.min.js"></script>
    <script defer src="/assets/js/vendor/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
    

    <!-- Mermaid 8.9.2 -->
    
    <script defer src="/assets/js/vendor/mermaid.min.js" onload="mermaid.initialize({startOnLoad:true});"></script>
    

    <!-- Simple Jekyll Search 1.9.1 -->
    <script src="/assets/js/vendor/simple-jekyll-search.min.js" type="text/javascript"></script>

    <!-- Google Analytics / Cookie Consent -->
    <script>
      const cookieName = 'cookie-notice-dismissed-https://sylhare.github.io';
      const isCookieConsent = 'false';
      const analyticsName = '';
    </script>

    
    

    <!-- seo tags -->
    <meta property="og:image" content="https://sylhare.github.io/assets/img/pexels/triangular.jpeg">
    
    <meta property="og:type" content="website" />
    
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>去闭包的宇宙看看 | Guo Yue Blog</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="去闭包的宇宙看看" />
<meta name="author" content="gua" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="前言" />
<meta property="og:description" content="前言" />
<link rel="canonical" href="https://sylhare.github.io/2021/08/06/JS2bibao.html" />
<meta property="og:url" content="https://sylhare.github.io/2021/08/06/JS2bibao.html" />
<meta property="og:site_name" content="Guo Yue Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-08-06T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="去闭包的宇宙看看" />
<script type="application/ld+json">
{"description":"前言","url":"https://sylhare.github.io/2021/08/06/JS2bibao.html","headline":"去闭包的宇宙看看","dateModified":"2021-08-06T00:00:00+08:00","datePublished":"2021-08-06T00:00:00+08:00","author":{"@type":"Person","name":"gua"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://sylhare.github.io/2021/08/06/JS2bibao.html"},"@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <!-- RSS -->
    <link type="application/atom+xml" rel="alternate" href="https://sylhare.github.io/feed.xml" title="Guo Yue Blog" />

    <!-- Twitter Cards -->
    <meta name="twitter:title" content="去闭包的宇宙看看">
    <meta name="twitter:description" content="前言学习闭包的时候，我的脑海中经常出现一个宇宙的画面。在我的理解中，作用域链、函数、闭包、变量之间的关系，就有点像漫威中的多元宇宙，他们之间的关系千丝万缕，而闭包就是宇宙间的桥梁。闭包所在的宇宙      全局变量：全局变量是最外层的作用域，闭包的故事，发生在最外层宇宙中，而这个外层宇宙就是我们的全局变量glob...">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:image" content="https://sylhare.github.io/assets/img/pexels/triangular.jpeg">
    <meta name="twitter:image:alt" content="去闭包的宇宙看看">
</head>

  <body>
    <header class="site-header">

    <!-- Logo and title -->
	<div class="branding">
        
		<a href="/">
			<img alt="logo img" class="avatar" src="/assets/img/triangle.png" />
		</a>
        
        <a class="site-title" aria-label="Guo Yue Blog" href="/">
        Guo Yue Blog
		</a>
	</div>

    <!-- Toggle menu -->
    <nav class="clear">
    <a aria-label="pull" id="pull" class="toggle" href="#">
    <i class="fas fa-bars fa-lg"></i>
    </a>

    <!-- Menu -->
    <ul class="hide">
        

        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="ABOUT" title="ABOUT" href="/about/">
                     ABOUT 
                </a>
            </li>
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="FOOTPRINT" title="FOOTPRINT" href="/footprint/">
                     FOOTPRINT 
                </a>
            </li>
            
            
        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="HOME" title="HOME" href="/">
                     HOME 
                </a>
            </li>
            
            
        
            
            
        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="PROJECT" title="PROJECT" href="/project/">
                     PROJECT 
                </a>
            </li>
            
            
        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Search" title="Search" href="/search/">
                     <i class="fas fa-search" aria-hidden="true"></i>
                    
                </a>
            </li>
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Tags" title="Tags" href="/tags/">
                     <i class="fas fa-tags" aria-hidden="true"></i>
                    
                </a>
            </li>
            
            
        
            
            
        
            
            
        
        
        
        <li class="separator"> | </li>
        <li><a id="theme-toggle" title="去闭包的宇宙看看 " aria-label="去闭包的宇宙看看" onclick="themeToggle()"></a></li>
        
    </ul>

	</nav>
</header>

    <div class="content">
      <article class="feature-image" >
  <header id="main" style="">
    <div class="title-padder">
      
      <h1 id="%E5%8E%BB%E9%97%AD%E5%8C%85%E7%9A%84%E5%AE%87%E5%AE%99%E7%9C%8B%E7%9C%8B" class="title">去闭包的宇宙看看</h1>
      


<div class="post-info">
    <p class="meta">
      
      
      August 06, 2021
    </p></div>

      
    </div>
  </header>

  <section class="post-content">
  
      <h2 id="前言">前言</h2>

<p>学习闭包的时候，我的脑海中经常出现一个宇宙的画面。</p>

<p>在我的理解中，作用域链、函数、闭包、变量之间的关系，就有点像漫威中的多元宇宙，他们之间的关系千丝万缕，而闭包就是宇宙间的桥梁。<!--more--></p>

<h2 id="闭包所在的宇宙">闭包所在的宇宙</h2>

<ul>
  <li>
    <p>全局变量：全局变量是最外层的作用域，闭包的故事，发生在最外层宇宙中，而这个外层宇宙就是我们的全局变量globalData。全局变量永远存在，就像宇宙永恒一般。</p>
  </li>
  <li>
    <p>作用域：作用域是每一个函数的执行环境，它就像一个个分支宇宙，存在于全局变量之中。</p>
  </li>
  <li>
    <p>作用域链：作用域链，就像是通往每个宇宙的空间通道。作用域链的前端始终都是当前执行的代码所在环境的变量对象，这条链从自己的作用域开始不断溯源，一直到全局执行环境。</p>
  </li>
  <li>
    <p>活动对象：活动对象就像是每个次级宇宙中的一切物质（属性和方法），它随着函数被创建而创建，随着函数被销毁而被销毁。</p>
  </li>
  <li>
    <p>闭包：闭包是一个拥有许多变量和绑定了这些变量的环境的表达式（通常是一个函数），因而这些变量也是该表达式的一部分。闭包就是能读取其他函数内部数据的函数。由于JavaScript中只有函数内部的子函数可以读取局部数据，所以js的闭包，其实就是定义在函数内部的函数。闭包本质上是连接函数内部和外部的桥梁。
闭包在这个多元宇宙中，是一个特殊的存在，他是沟通不同宇宙间活动对象的虫洞。</p>
  </li>
  <li>
    <p>由于闭包而产生的情况：</p>

    <p>由于闭包这座虫洞的存在。当二级宇宙被销毁时，二级宇宙只销毁了它的作用域链（也就是说，随着二级宇宙被销毁，去往二级宇宙的路被销毁了，我们再也不能通过这条路去拿二级宇宙的东西了）</p>

    <p>但是由于三级宇宙还在通过闭包虫洞在使用二级宇宙的活动对象，所以二级宇宙的活动对象并没有被销毁，还是占着内存空间。</p>

    <p>我们还是可以通过闭包借道三级宇宙去访问二级宇宙。而只有当三级宇宙也被销毁，真正的二级宇宙的活动对象才会被销毁。</p>

    <p>这似乎印证了一句格言：</p>

    <p>一个人一生要经历两次死亡，一次是身体死亡（作用域链销毁），一次是世间最后一个记得你的人死去（你的所有子函数都被销毁）。</p>
  </li>
</ul>

<h2 id="正文">正文</h2>

<h4 id="作用域链的创建">作用域链的创建</h4>

<p>当某个函数被调用时，会创建一个执行环境及相应的作用域链。然后，使用 arguments 和其他命名参数的值来初始化函数的活动对象。</p>

<p>但在作用域链中，外部函数的活动对象始终处于第二位，外部函数的外部函数的活动对象处于第三位，……直至作为作用域链终点的全局执行环境。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">compare</span><span class="p">(</span><span class="nx">value1</span><span class="p">,</span> <span class="nx">value2</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">value1</span> <span class="o">&lt;</span> <span class="nx">value2</span><span class="p">){</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">value1</span> <span class="o">&gt;</span> <span class="nx">value2</span><span class="p">){</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">compare</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
</code></pre></div></div>
<p><img src="https://img-blog.csdnimg.cn/20210810201824524.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2d1b195dWU=,size_16,color_FFFFFF,t_70" alt="img" /></p>

<p>全局环境的变量对象始终存在，而像compare()函数这样的局部环境的变量对象，则只在函数执行的过程中存在。</p>

<p>在创建函数时，会创建一个包含全局变量对象的作用域链，这个作用域链被保存在内部的[[Scope]]属性中。</p>

<p>当调用函数时，会为函数创建一个执行环境，然后通过复制函数的[[Scope]]属性中的对象构建起执行环境的作用域链。此后，又有一个活动对象被创建并被推入执行环境作用域链的前端。作用域链本质上是一个指向变量对象的指针列表。</p>

<p>一般来讲，当函数执行完毕后，局部活动对象就会被销毁，内存中仅保存全局作用域。</p>

<p><img src="https://img-blog.csdnimg.cn/20210810202133565.png" alt="img" /></p>

<p>(控制台打印的window对象中的某个参数的作用域，全局作用域global用于在作用域链的后端)</p>

<h4 id="存在闭包时作用域链的情况">存在闭包时作用域链的情况</h4>

<p>在一个函数内部定义的函数会将包含函数的活动对象添加到它的作用域链中。
所以，当外层函数在执行完毕后，其活动对象也不会被销毁，因为内层函数的作用域链仍然在引用这个活动对象。换句话说，当外层函数return后，其执行环境的作用域链会被销毁，但它的活动对象仍然会留在内存中；直到内层函数被销毁后外层的活动对象才会被销毁。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 没用使用闭包的时候，a是局部变量，即使先调用了了b()，也打印不出来变量a</span>
<span class="kd">function</span> <span class="nx">b</span><span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">aaa</span><span class="dl">'</span>
<span class="p">}</span>
<span class="nx">b</span><span class="p">();</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span><span class="c1">// 'a is not defined'</span>
<span class="c1">// 使用闭包后，虽然a是局部变量，但是b()通过return一个子函数，并且在外部定义新函数进行接收，最终打印出了变量a</span>
<span class="kd">function</span> <span class="nx">b</span><span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">aaa</span><span class="dl">'</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="nx">b</span><span class="p">()()</span><span class="c1">// 'aaa'</span>
</code></pre></div></div>

<p><img src="https://img-blog.csdnimg.cn/20210810201834101.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2d1b195dWU=,size_16,color_FFFFFF,t_70" alt="img" /></p>

<h4 id="闭包的作用">闭包的作用</h4>

<ol>
  <li>可以读取函数内部的变量</li>
  <li>可以让某些变量长期保存在内存中实现共享</li>
</ol>

<h4 id="闭包的缺点">闭包的缺点</h4>

<ol>
  <li>闭包会携带包含它的函数的作用域，所以闭包比其他函数更占内存；</li>
  <li>不合理地使用闭包会导致已经完成的函数的作用域仍然没有被回收；</li>
  <li>闭包允许了在父函数外部改变函数内部的值，这产生了父函数中值被错误改变的风险。</li>
</ol>

<h4 id="闭包使用中出现的问题">闭包使用中出现的问题</h4>

<p>作用域链的配置机制引出了问题，即闭包只能取得包含函数中任何变量的最后一个值。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">createFunctions</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
        <span class="nx">result</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="k">return</span> <span class="nx">i</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>上面的代码是一个常见的错误，我们希望0时返回0，1是返回1。但是实际上全部结果都是返回10。原因就是二级活动对象里面并没有i这个变量，我们每次调用，都直接取了createFunctions里面的活动对象的i变量。</p>

<p>解决上面代码出现的问题，我们通常会在每次for循环时都自执行一次function，这实际上就是在每个二级活动对象中都定义一个属于自己的变量i</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">createFunctions</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
         <span class="nx">result</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
             <span class="k">return</span> <span class="nx">i</span><span class="p">;</span>
         <span class="p">}(</span><span class="nx">i</span><span class="p">);</span>
    <span class="p">}</span>
<span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="最后">最后</h4>

    
  </section>

  <!-- Social media shares -->
  


   <!-- Tag list -->
  
  


  <div class="tag-list">
    <ul>
      
        <li class="meta">Tag</li>
      

      
        <li><a class="button" href="/tags#JavaScript">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> JavaScript</p>
        </a></li>
      
    </ul>
  </div>



</article>

<!-- Post navigation -->

<div id="post-nav">
    

    
    <div id="next-post">
        <a alt="小程序用户权限询问组件封装" href="/2021/08/05/XCX2quanxian.html">
            <p>Next post</p>
            小程序用户权限询问组件封装
        </a>
    </div>
    
</div>



<!--Utterances-->


<!-- Cusdis -->


<!-- Disqus -->


<!-- To change color of links in the page -->
<style>
  header#main {
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
  }
  
  
  .feature-image a { color: #929292 !important; }
  div#post-nav a { color: #929292 !important; }
  footer a { color: #929292 !important; }
  .site-header nav a:hover {  color: #929292 !important; }
  header#main { 
      background-color: #929292 !important;
      background-image: url('/assets/img/lineart.png');
  }
  
  
  
</style>

    </div>
    <footer class="site-footer">
    <p class="text">
        Hi, i am Gua<br> Powered by <a href="https://jekyllrb.com/">Jekyll</a> with <a href="https://github.com/sylhare/Type-on-Strap">Type on Strap</a>
</p>
            <div class="footer-icons">
                <ul>
                <!-- Social icons from Font Awesome, if enabled -->
                <!--  -->



                </ul>
            </div>
</footer>



  </body>
</html>
